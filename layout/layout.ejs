<!DOCTYPE html>
<html lang="<%= config.language %>" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= page.title ? page.title + ' | ' + config.title : config.title %></title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="<%= url_for('css/final.css') %>">
  <link rel="stylesheet" href="<%= url_for('css/style.css') %>">

  <!-- Google Analytics -->
  <% if (theme.google_analytics){ %>
  <script async src="https://www.googletagmanager.com/gtag/js?id=<%= theme.google_analytics %>"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', '<%= theme.google_analytics %>');
  </script>
  <% } %>
  
  <script>
    // Pass Hexo config to JS
    var hexo_config = {
        root: '<%= config.root %>'
    };
  </script>
  <style>
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
    .nav-link { position: relative; }
    .nav-link::after { content: ''; position: absolute; width: 0; height: 2px; bottom: -4px; left: 0; background-color: #4F46E5; transition: width 0.3s; }
    .dark .nav-link::after { background-color: #818CF8; }
    .nav-link:hover::after, .nav-link.active::after { width: 100%; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; font-size: 0.8rem; }
    .calendar-day { padding: 4px; border-radius: 4px; }
    .calendar-day.today { background-color: #4F46E5; color: white; font-weight: bold; }
  </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans min-h-screen flex flex-col dark:bg-slate-900 dark:text-slate-100 transition-colors duration-300">

  <%- partial('_partial/header') %>

  <main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full grid grid-cols-1 lg:grid-cols-12 gap-8">
     <% 
        // Categories, Tags & About pages are Full Width
        var hideSidebar = (page.layout === 'categories' || page.layout === 'tags' || page.layout === 'about');
     %>
     
     <!-- Main Content Area -->
     <div class="<%= hideSidebar ? 'lg:col-span-12' : 'lg:col-span-8' %>">
        <%- body %>
     </div>
    
     <!-- Sidebar (Conditional) -->
     <% if (!hideSidebar) { %>
        <aside class="lg:col-span-4 space-y-6">
          <%- partial('_partial/sidebar') %>
        </aside>
     <% } %>
  </main>

  <%- partial('_partial/footer') %>
  <%- partial('_partial/search') %>

  <!-- Back to Top Button -->
  <button id="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="fixed bottom-8 right-8 bg-primary dark:bg-primary-dark text-white w-12 h-12 rounded-full shadow-lg hover:bg-indigo-700 dark:hover:bg-indigo-500 transition-all z-50 flex items-center justify-center opacity-0 invisible transition-all duration-300">
      <i class="fas fa-arrow-up"></i>
  </button>

  <script>
      // Dark Mode
      const themeToggleBtn = document.getElementById('theme-toggle');
      const html = document.documentElement;
      
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          html.classList.add('dark');
      } else {
          html.classList.remove('dark');
      }

      themeToggleBtn?.addEventListener('click', () => {
          html.classList.toggle('dark');
          localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
      });

      // Mobile Menu
      function toggleMobileMenu() {
          document.getElementById('mobile-menu').classList.toggle('hidden');
      }

      // Back to Top Logic
      const backToTopBtn = document.getElementById('back-to-top');
      window.addEventListener('scroll', () => {
           if (window.scrollY > 300) {
               backToTopBtn.classList.remove('opacity-0', 'invisible');
               backToTopBtn.classList.add('opacity-100', 'visible');
           } else {
               backToTopBtn.classList.add('opacity-0', 'invisible');
               backToTopBtn.classList.remove('opacity-100', 'visible');
           }
      });
  </script>
</body>
</html>
